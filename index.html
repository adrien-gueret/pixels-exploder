<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pixels Exploder</title>
  <style>
    html {
      background-color: #e3e3e3;
      text-align: center;
    }

    canvas {
      border: 1px solid #000;
      background-color: #fff;
      display: none;
    }

    form {
      width: 25%;
      margin: auto;
      text-align: left;
    }

    img {
      cursor: pointer;
    }

    fieldset {
      background-color: #fff;
      margin: 10px;
    }

    fieldset nav {
      text-align: center;
    }

    legend {
      background-color: #e3e3e3;
      border-radius: 5px;
      padding: 5px 5px 2px 5px;
    }
  </style>
</head>
<body>
  <form>
    <fieldset>
      <legend>Select picture</legend>
      <label for="file">Select a file: </label>
      <input id="file" type="file" /><br />
      <b>OR</b><br />
      <label>Select one of these test-pictures: </label> <br />
      <nav>
        <img src="image_test_1.png" />
        <img src="image_test_2.png" />
        <img src="image_test_3.png" />
      </nav>
    </fieldset>
    <fieldset>
      <legend>Other options</legend>
      <label for="size">Pixels size:</label>
      <select id="size">
        <option>1</option>
        <option selected>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>10</option>
      </select>
      <br />
      <label for="color">Grid color:</label>
      <input id="color" type="color" value="#f3f3f3" />
    </fieldset>
  </form>

  <canvas id="results"></canvas>

  <script>
    var filePickcer = document.getElementById('file');
    var colorPicker = document.getElementById('color');
    var pixelsSizePicker = document.getElementById('size');
    var presetImages = document.getElementsByTagName('img');
    var resultsCanvas = document.getElementById('results');
    var resultsCtx = resultsCanvas.getContext('2d');

    var PIXEL_SIZE = parseInt(pixelsSizePicker.value, 10);
    var UPLOADED_IMAGE = null;

    filePickcer.addEventListener('change', inputChangeHandler);
    colorPicker.addEventListener('change', drawGrid);
    pixelsSizePicker.addEventListener('change', function() {
      PIXEL_SIZE = parseInt(pixelsSizePicker.value, 10);
      render();
    });

    for (var i = 0, l = presetImages.length; i < l; i++) {
      presetImages[i].addEventListener('click', imageClickHandler);
    }

    function imageClickHandler() {
      if (UPLOADED_IMAGE === this) {
        return;
      }

      UPLOADED_IMAGE = this;
      render();
    }

    function inputChangeHandler(e) {
      var fileReader = new FileReader();
      fileReader.onload = fileReaderLoadHandler;
      fileReader.readAsDataURL(e.target.files[0]);
    }

    function fileReaderLoadHandler() {
      UPLOADED_IMAGE = new Image();
      UPLOADED_IMAGE.onload = render;
      UPLOADED_IMAGE.src = this.result;
    }

    function render() {
      if (!UPLOADED_IMAGE) {
        return;
      }

      resultsCanvas.width = UPLOADED_IMAGE.naturalWidth * 2 * PIXEL_SIZE - PIXEL_SIZE;
      resultsCanvas.height = UPLOADED_IMAGE.naturalHeight * 2 * PIXEL_SIZE - PIXEL_SIZE;

      resultsCtx.imageSmoothingEnabled = false;
      resultsCtx.drawImage(UPLOADED_IMAGE, 0, 0, resultsCanvas.width, resultsCanvas.height);

      drawGrid();

      resultsCanvas.style.display = 'inline';
    }

    function drawGrid() {
      resultsCtx.beginPath();
      resultsCtx.strokeStyle = colorPicker.value;

      for (var i = PIXEL_SIZE; i < resultsCanvas.width; i += 2 * PIXEL_SIZE) {
        for (var j = 0; j < PIXEL_SIZE; j++) {
          resultsCtx.moveTo(i + j + .5, -1);
          resultsCtx.lineTo(i + j + .5, resultsCanvas.height);
        }
      }

      for (var i = PIXEL_SIZE; i < resultsCanvas.height; i += 2 * PIXEL_SIZE) {
        for (var j = 0; j < PIXEL_SIZE; j++) {
          resultsCtx.moveTo(-1, i + j + .5);
          resultsCtx.lineTo(resultsCanvas.width, i + j + .5);
        }
      }

      resultsCtx.stroke();
    }
  </script>
</body>
</html>